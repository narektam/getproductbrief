<script>
  // Function to get URL parameters
  function getQueryParam(param) {
    const params = new URLSearchParams(window.location.search);
    return params.get(param);
  }

  // Auto-fill email field if "email" parameter exists
  const emailParam = getQueryParam("email");
  if (emailParam) {
    document.getElementById("email").value = emailParam;
    // Optionally, make it read-only:
    // document.getElementById("email").readOnly = true;
  }
  
  // Handle form submission
  document.getElementById("updateForm").addEventListener("submit", function(e) {
    e.preventDefault();
    
    const email = document.getElementById("email").value;
    
    // Build the payload
    const payload = { email: email };
    
    // Call the webhook to get the subscription details
    fetch("https://narektamoyan.app.n8n.cloud/webhook/get-subscription", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
      console.log("Webhook response:", data); // Debug log
      
      if (data.error) {
        alert("Error: " + data.error);
      } else {
        let selectedSources = [];
        // Check if data.sources exists
        if (data.sources) {
          if (typeof data.sources === 'string') {
            // If data.sources is a string, split it directly
            selectedSources = data.sources.split(",").map(s => s.trim());
          } else if (Array.isArray(data.sources) && data.sources.length > 0) {
            // If it's an array, check if its first element is a string
            if (typeof data.sources[0] === 'string') {
              selectedSources = data.sources[0].split(",").map(s => s.trim());
            } else {
              console.warn("Unexpected format for sources:", data.sources);
            }
          }
        }
        
        if (selectedSources.length > 0) {
          // Reveal the sources container
          document.querySelector(".sources").style.display = "block";
          
          // Loop over all checkboxes in the sources section and check those that match selected sources
          const checkboxes = document.querySelectorAll('input[name="sources"]');
          checkboxes.forEach(checkbox => {
            checkbox.checked = selectedSources.includes(checkbox.value);
          });
        } else {
          // If no valid sources are returned, hide the sources container
          document.querySelector(".sources").style.display = "none";
          alert("No subscription preferences found for this email.");
        }
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("An error occurred while fetching your subscription details.");
    });
  });
</script>
